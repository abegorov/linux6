set -x  # Print commands and their arguments as they are executed.

# удаляем этот скрипт из автозагрузки:
rm /etc/cron.d/provision
+ rm /etc/cron.d/provision

# получаем старый и новый системный раздел по имени системного тома на нём:
OLD_PART=$(sudo pvs --no-headings -o pv_name,lv_name \
  | grep --word-regexp LogVol00Old | awk '{print $1}')
++ grep --word-regexp LogVol00Old
++ awk '{print $1}'
++ sudo pvs --no-headings -o pv_name,lv_name
+ OLD_PART=/dev/sda3
NEW_PART=$(sudo pvs --no-headings -o pv_name,lv_name \
  | grep --word-regexp LogVol00 | awk '{print $1}')
++ grep --word-regexp LogVol00
++ awk '{print $1}'
++ sudo pvs --no-headings -o pv_name,lv_name
+ NEW_PART=/dev/sdb1

# удаляем старый корневой том:
lvremove --yes /dev/mapper/VolGroup00-LogVol00Old
+ lvremove --yes /dev/mapper/VolGroup00-LogVol00Old
  Logical volume "LogVol00Old" successfully removed

# перемещаем том LogVol00 на другой диск
pvmove --name LogVol00 "${NEW_PART}" "${OLD_PART}"
+ pvmove --name LogVol00 /dev/sdb1 /dev/sda3
  /dev/sdb1: Moved: 0.00%
  /dev/sdb1: Moved: 100.00%

# генерируем файлы в /home:
mkdir /home/vagrant/files
+ mkdir /home/vagrant/files
for f in {01..20}; do
  dd if=/dev/urandom of="/home/vagrant/files/${f}.bin" bs=4096 count=1
done
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/01.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 8.338e-05 s, 49.1 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/02.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 8.0686e-05 s, 50.8 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/03.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.9726e-05 s, 58.7 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/04.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.9874e-05 s, 58.6 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/05.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 7.0052e-05 s, 58.5 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/06.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.6888e-05 s, 61.2 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/07.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.694e-05 s, 61.2 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/08.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 7.2702e-05 s, 56.3 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/09.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.7558e-05 s, 60.6 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/10.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.6751e-05 s, 61.4 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/11.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.6291e-05 s, 61.8 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/12.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.6668e-05 s, 61.4 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/13.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.5902e-05 s, 62.2 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/14.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.6175e-05 s, 61.9 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/15.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 8.4332e-05 s, 48.6 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/16.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.7736e-05 s, 60.5 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/17.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 7.9598e-05 s, 51.5 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/18.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.6951e-05 s, 61.2 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/19.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 8.3536e-05 s, 49.0 MB/s
+ for f in '{01..20}'
+ dd if=/dev/urandom of=/home/vagrant/files/20.bin bs=4096 count=1
1+0 records in
1+0 records out
4096 bytes (4.1 kB) copied, 6.6427e-05 s, 61.7 MB/s

# снимаем snapshot /home:
lvcreate --snapshot --size 1G --name SnapHome VolGroup00/LogVolHome
+ lvcreate --snapshot --size 1G --name SnapHome VolGroup00/LogVolHome
  Logical volume "SnapHome" created.

# удаляем часть файлов:
rm /home/vagrant/files/{11..20}.bin -f
+ rm /home/vagrant/files/11.bin /home/vagrant/files/12.bin /home/vagrant/files/13.bin /home/vagrant/files/14.bin /home/vagrant/files/15.bin /home/vagrant/files/16.bin /home/vagrant/files/17.bin /home/vagrant/files/18.bin /home/vagrant/files/19.bin /home/vagrant/files/20.bin -f
ls -la /home/vagrant/files/
+ ls -la /home/vagrant/files/
total 40
drwxr-xr-x. 2 root    root     146 Jul 25 19:56 .
drwx------. 4 vagrant vagrant   87 Jul 25 19:56 ..
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 01.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 02.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 03.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 04.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 05.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 06.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 07.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 08.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 09.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 10.bin

# восстанавливаем snapshot:
umount /home
+ umount /home
lvconvert --merge VolGroup00/SnapHome
+ lvconvert --merge VolGroup00/SnapHome
  Merging of volume VolGroup00/SnapHome started.
  VolGroup00/LogVolHome: Merged: 100.00%
mount /home
+ mount /home
ls -la /home/vagrant/files/
+ ls -la /home/vagrant/files/
total 80
drwxr-xr-x. 2 root    root     286 Jul 25 19:56 .
drwx------. 4 vagrant vagrant   87 Jul 25 19:56 ..
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 01.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 02.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 03.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 04.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 05.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 06.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 07.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 08.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 09.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 10.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 11.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 12.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 13.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 14.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 15.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 16.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 17.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 18.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 19.bin
-rw-r--r--. 1 root    root    4096 Jul 25 19:56 20.bin

# создаём том под /opt, форматируем, добавляем в fstab:
lvcreate --size 4G --name LogVolOpt VolGroup00 "${OLD_PART}"
+ lvcreate --size 4G --name LogVolOpt VolGroup00 /dev/sda3
WARNING: xfs_external_log signature detected on /dev/VolGroup00/LogVolOpt at offset 12288. Wipe it? [y/n]: [n]
  Aborted wiping of xfs_external_log.
  1 existing signature left on the device.
  Logical volume "LogVolOpt" created.
sleep 1  # ждём обновления информации о томах
+ sleep 1
mkfs.btrfs -f /dev/mapper/VolGroup00-LogVolOpt
+ mkfs.btrfs -f /dev/mapper/VolGroup00-LogVolOpt
btrfs-progs v4.9.1
See http://btrfs.wiki.kernel.org for more information.

Label:              (null)
UUID:               06571f98-0b45-45c8-bb1d-8d4ca18379b5
Node size:          16384
Sector size:        4096
Filesystem size:    4.00GiB
Block group profiles:
  Data:             single            8.00MiB
  Metadata:         DUP             204.75MiB
  System:           DUP               8.00MiB
SSD detected:       no
Incompat features:  extref, skinny-metadata
Number of devices:  1
Devices:
   ID        SIZE  PATH
    1     4.00GiB  /dev/mapper/VolGroup00-LogVolOpt


# создаём subvolume @opt на LogVolOpt и делаем его snapshot:
mount /dev/mapper/VolGroup00-LogVolOpt /mnt
+ mount /dev/mapper/VolGroup00-LogVolOpt /mnt
btrfs subvolume create /mnt/@opt
+ btrfs subvolume create /mnt/@opt
Create subvolume '/mnt/@opt'
btrfs subvolume snapshot /mnt/@opt \
  "/mnt/@opt_snapshot_$(date --iso-8601=seconds)"
++ date --iso-8601=seconds
+ btrfs subvolume snapshot /mnt/@opt /mnt/@opt_snapshot_2024-07-25T19:56:20+0000
Create a snapshot of '/mnt/@opt' in '/mnt/@opt_snapshot_2024-07-25T19:56:20+0000'
umount /mnt
+ umount /mnt

# подключаем cache:
lvconvert --yes --type cache --cachepool CachePool VolGroup00/LogVolOpt
+ lvconvert --yes --type cache --cachepool CachePool VolGroup00/LogVolOpt
  Logical volume VolGroup00/LogVolOpt is now cached.

# добавляем /opt в fstab и монтируем:
echo "/dev/mapper/VolGroup00-LogVolOpt /opt btrfs subvol=@opt 0 0" \
  >> /etc/fstab
+ echo '/dev/mapper/VolGroup00-LogVolOpt /opt btrfs subvol=@opt 0 0'
mount /opt
+ mount /opt
